#!/bin/env bash

# get a list of unstaged files and update timestamp if match regex before commit

DATE_RE='\(.* Last Change: \).*'

function gitroot() { # {{{
	git rev-parse --show-toplevel 2> /dev/null
}
# }}}
function stagefiles() { # {{{
	git diff --cached --name-only
}
# }}}
function update_timestamp() { # {{{
	local root files datenow

	files="$(stagefiles)"
	root="$(gitroot)"
	datenow="$(date +'%a %b %d %H:%M:%S %Z %Y')"

	for file in $files; do
		if [[ ! -d "$root/$file" ]]; then # some maybe submodules (directory)
			sed -i '5,15s/'"$DATE_RE"'/\1'"$datenow"'/' "$root/$file"
		fi
		git add "$file"
	done
}
# }}}

update_timestamp
