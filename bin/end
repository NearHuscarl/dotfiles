#!/bin/env bash

# Usage:
# $ ./end

# Dependencies:
# fzf

set -o errexit
set -o pipefail
set -o nounset
# set -o xtrace

SCRIPT_NAME=$(basename "$0")
USAGE="Usage: $SCRIPT_NAME [help|<signal>]"
HELP="\
$SCRIPT_NAME <command>

Kill process by typing the process name using fzf
Commands:
  h, help      print this help message
  <signal>     signal number to send to process. Default is 9 (SIGKILL)
               an alternative is to use signal 15 (SIGTERM) to terminate
               the program cleanly instead of killing it immediately"

TERM_COLS="$(tput cols)"
COLS="$(("$TERM_COLS"/2))"
BLUE="$(tput setaf 4)"
MAGENTA="$(tput setaf 5)"
CYAN="$(tput setaf 6)"
RESET="$(tput sgr0)"

function die () { # {{{
	echo "$*" >&2
	exit 1
}
# }}}
function usage() { # {{{
	die "$USAGE"
}
# }}}
function help() { # {{{
	echo "$HELP"
}
# }}}
function search() { # {{{
	local header
	header="$(ps aux | head -n1)"
	fzf --ansi --multi --header="$header" 
}
# }}}
function color() { # {{{
	local rplc='^\([^ ]\+ \+\)\([0-9]\+ \+\)\([0-9.]\+ \+[0-9.]\+ \+\)\([0-9]\+ \+[0-9]\+ \+[^ ]\+ \+[^ ]\+ \+\)\([^ ]\+ \+[^ ]\+ \+\)\(.*$\)$'
	sed 's/'"$rplc"'/'"$MAGENTA"'\1'"$CYAN"'\2'"$BLUE"'\3'"$RESET"'\4'"$MAGENTA"'\5'"$CYAN"'\6'"$RESET"'/'
}
# }}}
function kill_process() { # {{{
	local signal="${1:-9}"
	local pid

	pid="$(ps aux | sed 1d | cut -c 1-$(("$TERM_COLS")) | color | search | awk '{print $2}')"
	if [[ "$pid" != '' ]]; then # keyboard interruption like CTRL-C
		echo "$pid" | xargs kill -"$signal"
	fi
}
# }}}
function main() { # {{{
	local cmd="${1:-}"

	case "$#" in
		0)
			kill_process ;;
		*)
			case "$cmd" in
				h|help)
					help ;;
				[0-9][0-9])
					kill_process "$cmd" ;;
				*)
					usage ;;
			esac
	esac
}
main "$@"
# }}}
